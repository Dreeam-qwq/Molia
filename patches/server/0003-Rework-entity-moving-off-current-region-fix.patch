From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: MrHua269 <wangxyper@163.com>
Date: Sat, 12 Aug 2023 09:31:46 +0800
Subject: [PATCH] Rework entity moving off current region fix


diff --git a/src/main/java/net/minecraft/world/entity/Entity.java b/src/main/java/net/minecraft/world/entity/Entity.java
index d45a327451eca246804291463e107f02c3eabfa0..c6189a1354572c9492ee827ab67fd257fbce957b 100644
--- a/src/main/java/net/minecraft/world/entity/Entity.java
+++ b/src/main/java/net/minecraft/world/entity/Entity.java
@@ -7,6 +7,7 @@ import com.google.common.collect.Lists;
 import com.google.common.collect.Sets;
 import com.google.common.collect.UnmodifiableIterator;
 import com.mojang.logging.LogUtils;
+import io.papermc.paper.util.TickThread;
 import it.unimi.dsi.fastutil.objects.Object2DoubleArrayMap;
 import it.unimi.dsi.fastutil.objects.Object2DoubleMap;
 import java.util.Arrays;
@@ -1125,7 +1126,31 @@ public abstract class Entity implements Nameable, EntityAccess, CommandSource {
                     }
                 }
 
-                try { // Kaiiju - Teleport async if we cannot move entity off-main
+                //Molia start - Rework this fix
+                var finalX = this.getX() + vec3d1.x;
+                var finalY = this.getY() + vec3d1.y;
+                var finalZ = this.getZ() + vec3d1.z;
+
+                if (TickThread.isTickThreadFor(((ServerLevel) this.level),(int)finalX >> 4,(int)finalZ >> 4)){
+                    this.setPos(finalX, finalY, finalZ); //Only move it if the target position is in current region
+                }else{
+                    if (this.level().kaiijuConfig.teleportAsyncOnHighVelocity){ //Kaiiju config
+                        //Teleport async if the target position is not in current region
+                        this.teleportAsync(
+                                ((ServerLevel) this.level),
+                                this.position().add(vec3d1),
+                                this.getYRot(),
+                                this.getXRot(),
+                                null,
+                                PlayerTeleportEvent.TeleportCause.UNKNOWN,
+                                Entity.TELEPORT_FLAG_LOAD_CHUNK | Entity.TELEPORT_FLAG_TELEPORT_PASSENGERS,
+                                null
+                        );
+                    }else{
+                        throw new IllegalStateException(); //Throw if the fix is not enabled.
+                    }
+                }
+                /*try { // Kaiiju - Teleport async if we cannot move entity off-main
                 this.setPos(this.getX() + vec3d1.x, this.getY() + vec3d1.y, this.getZ() + vec3d1.z);
                 // Kaiiju start - Teleport async if we cannot move entity off-main
                 } catch (IllegalStateException e) {
@@ -1138,7 +1163,8 @@ public abstract class Entity implements Nameable, EntityAccess, CommandSource {
                     );
                     else LOGGER.error("High velocity entity caused off-main setPos: ", e);
                 }
-                // Kaiiju end
+                // Kaiiju end*/
+                //Molia end
             }
 
             this.level().getProfiler().pop();
