From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: MrHua269 <wangxyper@163.com>
Date: Sat, 12 Aug 2023 11:38:30 +0800
Subject: [PATCH] Init config on server startup


diff --git a/src/main/java/me/earthme/molia/MoliaConfig.java b/src/main/java/me/earthme/molia/MoliaConfig.java
index b980d2d7b1b3b383be484c7502cc1ec1d6f32907..a6768632645cf58efeab9242aa891c0f1a65c39a 100644
--- a/src/main/java/me/earthme/molia/MoliaConfig.java
+++ b/src/main/java/me/earthme/molia/MoliaConfig.java
@@ -1,5 +1,6 @@
 package me.earthme.molia;
 
+import com.google.common.collect.Lists;
 import net.minecraft.core.registries.BuiltInRegistries;
 import net.minecraft.world.entity.EntityType;
 import org.bukkit.configuration.InvalidConfigurationException;
@@ -7,15 +8,26 @@ import org.bukkit.configuration.file.YamlConfiguration;
 
 import java.io.File;
 import java.io.IOException;
+import java.util.List;
 
 public class MoliaConfig {
     //All values
+
+    //Optimizations
     public static double entityWakeUpDurationRatioStandardDeviation = 0.2;
     public static boolean enableSuffocationOptimization = true;
     public static boolean dabEnabled = true;
     public static int maximumActivationPrio = 20;
     public static int startDistanceSquared;
     public static int activationDistanceMod = 8;
+    //Gameplay
+    public static boolean fakeplayerSupport = false;
+    public static boolean alwaysSendFakeplayerData = true;
+    public static boolean fakeplayerSkipSleep = true;
+    public static boolean openFakeplayerInventory = true;
+    public static boolean fakeplayerResident = false;
+    public static List<String> unableFakeplayerNames = Lists.newArrayList();
+    public static int fakeplayerLimit = 10;
     //
 
     private static final YamlConfiguration configEntry = new YamlConfiguration();
@@ -38,6 +50,11 @@ public class MoliaConfig {
         startDistanceSquared = getInt("optimizations.dab.start_distance",12) ^ 2;
         maximumActivationPrio = getInt("optimizations.dab.max_tick_freq",maximumActivationPrio);
         activationDistanceMod = getInt("optimizations.dab.activation_distance_mod",activationDistanceMod);
+
+        //Gameplay
+        fakeplayerSupport = getBoolean("gameplay.leaves.fakeplayer.enabled",fakeplayerSupport);
+        fakeplayerLimit = getInt("gameplay.leaves.fakeplayer.fake_player_limit",fakeplayerLimit);
+        unableFakeplayerNames = getStringList("gameplay.leaves.fakeplayer.name_black_list",unableFakeplayerNames);
     }
 
     public static void init(){
@@ -48,6 +65,8 @@ public class MoliaConfig {
             e.printStackTrace();
         }
         configEntry.options().copyDefaults(true);
+
+        loadOrInitAll();
     }
 
     public static void save(){
@@ -82,4 +101,9 @@ public class MoliaConfig {
         configEntry.addDefault(key,def);
         return configEntry.getDouble(key);
     }
+
+    public static List<String> getStringList(String key,List<String> def){
+        configEntry.addDefault(key,def);
+        return configEntry.getStringList(key);
+    }
 }
diff --git a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
index 24a2d3f496727790f63cb66a2534d4423555fa3c..95f3c3ee503aa3c8db58feb54ec4aadda65766af 100644
--- a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
+++ b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
@@ -19,6 +19,8 @@ import java.util.Locale;
 import java.util.Optional;
 import java.util.function.BooleanSupplier;
 import javax.annotation.Nullable;
+
+import me.earthme.molia.MoliaConfig;
 import net.minecraft.DefaultUncaughtExceptionHandler;
 import net.minecraft.DefaultUncaughtExceptionHandlerWithName;
 import net.minecraft.SharedConstants;
@@ -199,6 +201,7 @@ public class DedicatedServer extends MinecraftServer implements ServerInterface
             this.setPreventProxyConnections(dedicatedserverproperties.preventProxyConnections);
             this.setLocalIp(dedicatedserverproperties.serverIp);
         }
+        MoliaConfig.init(); //Molia
         // Spigot start
         this.setPlayerList(new DedicatedPlayerList(this, this.registries(), this.playerDataStorage));
         org.spigotmc.SpigotConfig.init((java.io.File) options.valueOf("spigot-settings"));
